name: Build Release Artifacts

on:
  push:
    tags:
      - "v*"

jobs:
  windows_installer:
    name: Windows Installer (Electron NSIS)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies (electron-wrapper)
        working-directory: electron-wrapper
        run: npm ci

      - name: Build installer
        working-directory: electron-wrapper
        run: npm run dist

      - name: Zip Windows installer
        shell: pwsh
        run: |
          $dist = "electron-wrapper/dist"
          $exe = Get-ChildItem $dist -Filter "*.exe" | Select-Object -First 1
          if (-not $exe) { throw "No installer EXE found in $dist" }
          $zipPath = Join-Path $dist "SkydivingDashboard-Windows-Installer.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath }
          Compress-Archive -Path $exe.FullName -DestinationPath $zipPath
          echo "ZIP_CREATED=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Upload artifacts (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            electron-wrapper/dist/*.exe
            electron-wrapper/dist/*.zip

  pi_bundle:
    name: Raspberry Pi Bundle (Kiosk)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Pi bundle zip
        run: |
          mkdir -p release/pi/skydiving-dashboard
          cp dashboard.html release/pi/skydiving-dashboard/
          cp dz_feed_server.py release/pi/skydiving-dashboard/
          cp -r config release/pi/skydiving-dashboard/config

          # Include pi installer scripts if present (we'll add them next)
          if [ -d "pi" ]; then
            cp -r pi release/pi/skydiving-dashboard/pi
          fi

          cd release/pi
          zip -r SkydivingDashboard-RaspberryPi-Kiosk.zip skydiving-dashboard

      - name: Upload artifact (Pi)
        uses: actions/upload-artifact@v4
        with:
          name: pi-kiosk-bundle
          path: release/pi/SkydivingDashboard-RaspberryPi-Kiosk.zip

  publish_release:
    name: Publish GitHub Release Assets
    needs: [windows_installer, pi_bundle]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: List assets
        run: ls -R release-assets

      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-assets/**/*
